<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¦è¾†å››è§†å›¾ç›‘æ§</title>
    <script src="dist/missile.js"></script>
    <script src="dist/h265webjs-v20221106.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            display: grid;
            grid-template-rows: 33.33vh 66.67vh;
            position: relative;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: background-color 0.3s;
        }
        
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .back-button::before {
            content: '<';
            font-size: 24px;
            font-weight: bold;
        }
        
        .top-views {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            background-color: #111;
            gap: 0;
        }
        
        .bottom-view {
            width: 100%;
            height: 100%;
            background-color: #222;
            position: relative;
        }
        
        .view {
            flex: 1;
            background-color: #000;
            position: relative;
            overflow: hidden;
        }
        
        .view:not(:last-child) {
            margin-right: 1px;
        }
        
        .view-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .player {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        /* ç¡®ä¿è§†é¢‘å®Œå…¨å¡«å……å®¹å™¨ */
        .player video, .player canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover; /* ä¿æŒå®½é«˜æ¯”å¹¶å¡«å……å®¹å™¨ï¼Œå¯èƒ½ä¼šè£å‰ªéƒ¨åˆ†ç”»é¢ */
            /* ä½¿ç”¨ object-fit: fill; ä¼šå®Œå…¨æ‹‰ä¼¸è§†é¢‘å¡«æ»¡å®¹å™¨ï¼Œä½†å¯èƒ½å¯¼è‡´å˜å½¢ */
        }

        /* ç¡®ä¿h265webjsåˆ›å»ºçš„æ’­æ”¾å™¨å…ƒç´ ä¹Ÿèƒ½å¡«æ»¡å®¹å™¨ */
        #leftPlayer, #backPlayer, #rightPlayer, #frontPlayer {
            width: 100% !important;
            height: 100% !important;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="back-button" id="backButton"></div>
        
        <div class="top-views">
            <div class="view">
                <div class="view-label">å·¦è§†å›¾</div>
                <div id="leftPlayer" class="player"></div>
                <div id="leftLoading" class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="view">
                <div class="view-label">åè§†å›¾</div>
                <div id="backPlayer" class="player"></div>
                <div id="backLoading" class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="view">
                <div class="view-label">å³è§†å›¾</div>
                <div id="rightPlayer" class="player"></div>
                <div id="rightLoading" class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <div class="bottom-view">
            <div id="frontPlayer" class="player"></div>
            <div id="frontLoading" class="loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const config = {
            token: '', 
            vid: '',
            startUrl: '', 
            stopUrl: ''
        };

        // ä»URLå‚æ•°ä¸­è·å–é…ç½®
        function getConfigFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const httpAddress = urlParams.get('httpAddress');
            const token = urlParams.get('token');
            const vin = urlParams.get('vin');
            
            if (httpAddress) {
                // ç§»é™¤æœ«å°¾çš„æ–œæ ï¼ˆå¦‚æœæœ‰ï¼‰
                const baseUrl = httpAddress.replace(/\/$/, '');
                config.startUrl = `${baseUrl}/startVideoPlay`;
                config.stopUrl = `${baseUrl}/stopVideoPlay`;
            }
            
            if (token) {
                config.token = token;
            }
            
            if (vin) {
                config.vid = vin;
            }
        }

        // è·å–URLå‚æ•°ä¸­çš„é…ç½®
        getConfigFromUrlParams();

        // è§†é¢‘é€šé“é…ç½®
        const videoChannels = [
            { id: 0, name: 'center', label: 'å‰è§†å›¾', playerId: 'frontPlayer', loadingId: 'frontLoading' },
            { id: 1, name: 'back', label: 'åè§†å›¾', playerId: 'backPlayer', loadingId: 'backLoading' },
            { id: 2, name: 'left', label: 'å·¦è§†å›¾', playerId: 'leftPlayer', loadingId: 'leftLoading' },
            { id: 3, name: 'right', label: 'å³è§†å›¾', playerId: 'rightPlayer', loadingId: 'rightLoading' }
        ];

        // å­˜å‚¨æ’­æ”¾å™¨å®ä¾‹å’Œè§†é¢‘URL
        const players = {};
        const videoUrls = {};

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', async function() {
            // æ³¨å†Œè¿”å›æŒ‰é’®äº‹ä»¶
            document.getElementById('backButton').addEventListener('click', handleBackButtonClick);
            
            // å¯åŠ¨æ‰€æœ‰è§†é¢‘æ’­æ”¾
            await startAllVideos();
        });

        // å¯åŠ¨æ‰€æœ‰è§†é¢‘
        async function startAllVideos() {
            // åˆ¤æ–­é…ç½®æ˜¯å¦æœ‰æ•ˆ, å¦‚æœæ— æ•ˆç›´æ¥alerté€€å‡º
            if (config.startUrl === '' || config.token === '' || config.vid === '') {
                alert('è¯·ä»URLå‚æ•°ä¸­ä¼ å…¥æœ‰æ•ˆé…ç½®');
                return;
            }
            
            console.log('å¯åŠ¨è§†é¢‘æ’­æ”¾');
            const promises = videoChannels.map(async (channel) => {
                try {
                    await startVideoPlay(channel);
                } catch (error) {
                    console.error(`å¯åŠ¨${channel.label}å¤±è´¥:`, error);
                    const loadingElement = document.getElementById(channel.loadingId);
                    if (loadingElement) {
                        loadingElement.textContent = 'åŠ è½½å¤±è´¥';
                    }
                }
            });
            
            await Promise.all(promises);
        }

        // å¯åŠ¨å•ä¸ªè§†é¢‘æ’­æ”¾ï¼ˆåœ¨çœŸå®ç¯å¢ƒä¸­ä½¿ç”¨ï¼‰
        async function startVideoPlay(channel, retryCount = 0) {
            const url = `${config.startUrl}?token=${config.token}&vid=${config.vid}&videoChannel=${channel.id}`;
            
            try {
                // ä½¿ç”¨AbortControllerå®ç°è¯·æ±‚è¶…æ—¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.code === 200 && data.flv) {
                    // æå–flv URLï¼ˆå»é™¤å‰åçš„ç©ºæ ¼å’Œåå¼•å·ï¼‰
                    const flvUrl = data.flv.replace(/[\s`]/g, '');
                    videoUrls[channel.id] = flvUrl;
                    
                    // åˆ›å»ºå¹¶å¯åŠ¨æ’­æ”¾å™¨
                    createPlayer(channel, flvUrl);
                } else {
                    throw new Error(`è·å–${channel.label}è§†é¢‘é“¾æ¥å¤±è´¥: ${data.msg || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error(`è¯·æ±‚${channel.label}è§†é¢‘æ’­æ”¾é“¾æ¥å¤±è´¥:`, error);
                
                // é‡è¯•é€»è¾‘ï¼šå¦‚æœæ˜¯AbortErrorï¼ˆè¶…æ—¶æˆ–å–æ¶ˆï¼‰ä¸”é‡è¯•æ¬¡æ•°å°äº3ï¼Œåˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                if ((error.name === 'AbortError' || error.message.includes('aborted')) && retryCount < 3) {
                    console.log(`è¯·æ±‚${channel.label}è¶…æ—¶ï¼Œ${retryCount + 1}ç§’åé‡è¯•ï¼ˆ${retryCount + 1}/3ï¼‰`);
                    await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 1000));
                    return startVideoPlay(channel, retryCount + 1);
                }
                
                throw error;
            }
        }

        // åˆ›å»ºæ’­æ”¾å™¨
        function createPlayer(channel, videoUrl) {
            const playerConfig = {
                player: channel.playerId,
                width: '100%',
                height: '100%',
                token: 'base64:QXV0aG9yOmNoYW5neWFubG9uZ3xudW1iZXJ3b2xmLEdpdGh1YjpodHRwczovL2dpdGh1Yi5jb20vbnVtYmVyd29sZixFbWFpbDpwb3JzY2hlZ3QyM0Bmb3htYWlsLmNvbSxRUTo1MzEzNjU4NzIsSG9tZVBhZ2U6aHR0cDovL3h2aWRlby52aWRlbyxEaXNjb3JkOm51bWJlcndvbGYjODY5NCx3ZWNoYXI6bnVtYmVyd29sZjExLEJlaWppbmcsV29ya0luOkJhaWR1',
                extInfo: {
                    coreProbePart: 0.1,
                    probeSize: 1024,
                    ignoreAudio: 1,
                    coreProbePart: 0.1,
                    autoPlay: true,
                    cacheLength: 10,
                    rawFps: 30
                }
            };

            try {
                // config = JSON.parse(playerConfig);
                // config = playerConfig;
                console.log("config:", playerConfig);
                // åˆ›å»ºæ’­æ”¾å™¨å®ä¾‹
                const player = window.new265webjs(videoUrl, playerConfig);
                
                // ç›‘å¬æ’­æ”¾å™¨äº‹ä»¶
                player.onReadyShowDone = function() {
                    // éšè—åŠ è½½æç¤º
                    document.getElementById(channel.loadingId).style.display = 'none';
                };
                
                player.onLoadError = function() {
                    document.getElementById(channel.loadingId).textContent = 'è§†é¢‘åŠ è½½é”™è¯¯';
                };
                
                // å­˜å‚¨æ’­æ”¾å™¨å®ä¾‹
                players[channel.id] = player;
                
                // å¯åŠ¨æ’­æ”¾
                player.do();
            } catch (error) {
                console.error(`åˆ›å»º${channel.label}æ’­æ”¾å™¨å¤±è´¥:`, error);
                // æ˜¾ç¤ºæ¨¡æ‹Ÿçš„è§†é¢‘å ä½ç¬¦
                const playerElement = document.getElementById(channel.playerId);
                playerElement.innerHTML = `
                    <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background-color:#111;">
                        <div style="text-align:center;">
                            <div style="font-size:48px; margin-bottom:10px;">ğŸ“¹</div>
                            <div>${channel.label}</div>
                            <div style="font-size:12px; color:#666; margin-top:5px;">è§†é¢‘è¿æ¥ä¸­...</div>
                        </div>
                    </div>
                `;
                document.getElementById(channel.loadingId).style.display = 'none';
            }
        }

        // åœæ­¢æ‰€æœ‰è§†é¢‘æ’­æ”¾
        async function stopAllVideos() {
            // åœ¨æœ¬åœ°ç¯å¢ƒä¸­ï¼Œä½¿ç”¨æ¨¡æ‹Ÿçš„åœæ­¢æ“ä½œ
            console.log('åœæ­¢æ‰€æœ‰è§†é¢‘æ’­æ”¾');
            
            const promises = videoChannels.map(async (channel) => {
                try {
                    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 100 + Math.random() * 300));
                    
                    // æ¨¡æ‹Ÿåœæ­¢è§†é¢‘æ’­æ”¾
                    const mockResult = await mockStopVideoPlay(channel.id);
                    console.log(`åœæ­¢${channel.label}æˆåŠŸ:`, mockResult);
                    
                    // é‡Šæ”¾æ’­æ”¾å™¨èµ„æº
                    if (players[channel.id]) {
                        try {
                            players[channel.id].release();
                        } catch (e) {
                            console.error(`é‡Šæ”¾${channel.label}æ’­æ”¾å™¨èµ„æºå¤±è´¥:`, e);
                        }
                        players[channel.id] = null;
                    }
                } catch (error) {
                    console.error(`åœæ­¢${channel.label}å¤±è´¥:`, error);
                }
            });
            
            await Promise.all(promises);
        }

        // æ¨¡æ‹Ÿåœæ­¢è§†é¢‘æ’­æ”¾ï¼ˆåœ¨æœ¬åœ°ç¯å¢ƒä¸­ä½¿ç”¨ï¼‰
        async function mockStopVideoPlay(channelId) {
            const url = `${config.stopUrl}?token=${config.token}&vid=${config.vid}&videoChannel=${channelId}`;
            
            try {
                const response = await fetch(url, { timeout: 3000 });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`åœæ­¢${channelId}è§†é¢‘æ’­æ”¾è¯·æ±‚å¤±è´¥:`, error);
                throw error;
            }
        }

        // åœæ­¢å•ä¸ªè§†é¢‘æ’­æ”¾ï¼ˆåœ¨çœŸå®ç¯å¢ƒä¸­ä½¿ç”¨ï¼‰
        async function stopVideoPlay(channelId) {
            const url = `${config.stopUrl}?token=${config.token}&vid=${config.vid}&videoChannel=${channelId}`;
            
            try {
                // æ·»åŠ è¶…æ—¶è®¾ç½®ï¼Œé¿å…è¯·æ±‚æ—¶é—´è¿‡é•¿
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                
                const response = await fetch(url, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.code !== 200) {
                    console.warn(`åœæ­¢è§†é¢‘é€šé“${channelId}å“åº”å¼‚å¸¸:`, data);
                }
                
                return data;
            } catch (error) {
                console.error(`åœæ­¢è§†é¢‘é€šé“${channelId}è¯·æ±‚å¤±è´¥:`, error);
                // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œåç»­æ“ä½œ
                return { code: 500, msg: error.message };
            }
        }

        // å¤„ç†è¿”å›æŒ‰é’®ç‚¹å‡»
        async function handleBackButtonClick() {
            try {
                // åœæ­¢æ‰€æœ‰è§†é¢‘ï¼ˆä¸ç­‰å¾…å®Œæˆï¼Œé¿å…é˜»å¡UIï¼‰
                stopAllVideos().then(() => {
                    console.log('æ‰€æœ‰è§†é¢‘å·²åœæ­¢');
                }).catch(error => {
                    console.error('åœæ­¢è§†é¢‘æ—¶å‡ºé”™:', error);
                });
                
                // è¿”å›ä¸Šä¸€é¡µ
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œå¯ä»¥è·³è½¬åˆ°ä¸€ä¸ªé»˜è®¤é¡µé¢æˆ–æ˜¾ç¤ºæç¤º
                    alert('å·²è¿”å›é¦–é¡µ');
                }
            } catch (error) {
                console.error('å¤„ç†è¿”å›æ“ä½œå¤±è´¥:', error);
                // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•è¿”å›ä¸Šä¸€é¡µ
                if (window.history.length > 1) {
                    window.history.back();
                }
            }
        }

        // é¡µé¢å¸è½½æ—¶é‡Šæ”¾èµ„æº
        window.addEventListener('beforeunload', async function() {
            try {
                await stopAllVideos();
            } catch (error) {
                console.error('é¡µé¢å¸è½½æ—¶é‡Šæ”¾èµ„æºå¤±è´¥:', error);
            }
        });
    </script>
</body>
</html>